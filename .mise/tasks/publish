#!/usr/bin/env bash
#MISE description="Publish to npm registry"
#MISE depends=["setup", "build"]
#USAGE flag "-t --tag <tag>" "Tag to publish with" default="latest"

set -e

# Guard: Only allow publishing from main branch in CI
if [ -n "$GITHUB_ACTIONS" ]; then
  BRANCH="${GITHUB_REF_NAME:-unknown}"
  # GITHUB_HEAD_REF is set for pull_request events, which we don't publish from
  if [ "$BRANCH" != "main" ] && [ -z "$GITHUB_HEAD_REF" ]; then
    echo "ERROR: Publishing only allowed from main branch (current: $BRANCH)"
    exit 1
  fi
  echo "Branch check passed: $BRANCH"
fi

echo "Publishing to npm"
echo " > with tag: ${usage_tag}..."
echo " > npm version: $(npm --version)"

# Determine if we should use provenance
# Only enable in CI environments with OIDC support
PROVENANCE_FLAG=""
if [ -z "$GITHUB_ACTIONS" ]; then
  # Local development: disable provenance (fails without CI provider context)
  PROVENANCE_FLAG="--no-provenance"
  echo " > provenance: disabled (local environment)"
else
  # GitHub Actions: enable provenance (OIDC will handle it automatically)
  echo " > provenance: enabled (GitHub Actions with OIDC)"
fi

# Publish directly from source (allows provenance generation in CI)
npm publish \
  --access public \
  --tag "${usage_tag}" \
  $PROVENANCE_FLAG

echo "Published successfully!"
