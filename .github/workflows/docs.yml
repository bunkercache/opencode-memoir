name: Deploy Docs

on:
  push:
    branches: [main]
    paths:
      - 'scripts/generate-docs.ts'
      - 'schema/**'
      - 'src/types.ts'
      - 'README.md'
      - '.github/workflows/docs.yml'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., v1.0.0, dev, latest)'
        required: false
        default: 'dev'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    # Skip prereleases - only build docs for stable releases
    if: |
      github.event_name != 'release' ||
      !github.event.release.prerelease
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2.1.2
        with:
          bun-version: latest

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # Stable release â†’ create versioned docs AND update latest
            VERSION="${{ github.event.release.tag_name }}"
            IS_LATEST="true"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            # Only set is_latest if explicitly requesting "latest"
            if [[ "$VERSION" == "latest" ]]; then
              IS_LATEST="true"
              # Get the latest release tag for the actual version
              VERSION=$(gh release list --exclude-pre-releases --limit 1 --json tagName -q '.[0].tagName')
            else
              IS_LATEST="false"
            fi
          else
            # Push to main branch = dev docs only
            VERSION="dev"
            IS_LATEST="false"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_latest=$IS_LATEST" >> $GITHUB_OUTPUT
          echo "Publishing docs for version: $VERSION (is_latest: $IS_LATEST)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0

      - name: Restore existing versions
        continue-on-error: true
        run: |
          mkdir -p _site

          # Try to fetch existing gh-pages content to preserve other versions
          git fetch origin gh-pages:gh-pages 2>/dev/null || exit 0

          # Checkout only the version directories we want to preserve
          for dir in $(git ls-tree --name-only gh-pages | grep -E '^(v[0-9]|dev|latest)'); do
            git checkout gh-pages -- "$dir" 2>/dev/null && mv "$dir" "_site/" || true
          done

          # Also get versions.json if it exists
          git checkout gh-pages -- versions.json 2>/dev/null && mv versions.json _site/ || true

      - name: Generate docs
        env:
          DOCS_VERSION: ${{ steps.version.outputs.version }}
          DOCS_BASE_URL: https://bunkercache.github.io/opencode-memoir
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IS_LATEST="${{ steps.version.outputs.is_latest }}"

          # Generate docs to dist-docs/
          bun run scripts/generate-docs.ts

          # Move generated docs to versioned directory
          rm -rf "_site/$VERSION"
          mv dist-docs "_site/$VERSION"

          # If this is a stable release, also update /latest/
          if [[ "$IS_LATEST" == "true" ]]; then
            rm -rf "_site/latest"
            cp -r "_site/$VERSION" "_site/latest"

            # Update the $id in latest to say "latest" not the version
            sed -i "s|/$VERSION/schema|/latest/schema|g" "_site/latest/schema/config.schema.json"

            # Also copy to root for default access
            cp "_site/latest/index.html" "_site/"
            cp -r "_site/latest/schema" "_site/"
          fi

      - name: Update versions.json
        run: |
          # Build versions.json with proper sorting:
          # 1. latest (alias for most recent stable release)
          # 2. dev (main branch, unreleased)
          # 3. Versioned releases in descending order (v1.1.0, v1.0.0, ...)

          echo "[" > _site/versions.json
          FIRST=true

          # latest first (if exists)
          if [[ -d "_site/latest" ]]; then
            echo '  "latest"' >> _site/versions.json
            FIRST=false
          fi

          # dev second (main branch)
          if [[ -d "_site/dev" ]]; then
            if [[ "$FIRST" != "true" ]]; then echo "," >> _site/versions.json; fi
            echo '  "dev"' >> _site/versions.json
            FIRST=false
          fi

          # Then versioned releases (sorted descending, excluding prereleases)
          for v in $(ls -d _site/v* 2>/dev/null | xargs -n1 basename 2>/dev/null | grep -v '\-' | sort -rV); do
            if [[ "$FIRST" != "true" ]]; then echo "," >> _site/versions.json; fi
            echo "  \"$v\"" >> _site/versions.json
            FIRST=false
          done

          echo "" >> _site/versions.json
          echo "]" >> _site/versions.json

          echo "Available versions:"
          cat _site/versions.json

      - name: Upload artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: _site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
